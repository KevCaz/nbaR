<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calibrating a molecular phylogeny of the sharks • nbaR</title>
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.1/clipboard.min.js" integrity="sha256-hIvIxeqhGZF+VVeM55k0mJvWpQ6gTkWk3Emc+NmowYA=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Calibrating a molecular phylogeny of the sharks">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">nbaR</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/nbaR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/sharks.html">Calibrating a molecular phylogeny of the sharks</a>
    </li>
    <li>
      <a href="../articles/tomato.html">The oldest tomato specimen in the world</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/naturalis/nbaR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Calibrating a molecular phylogeny of the sharks</h1>
            
            <h4 class="date">Dec 06, 2018</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/naturalis/nbaR/blob/master/vignettes/sharks.Rmd"><code>vignettes/sharks.Rmd</code></a></small>
      <div class="hidden name"><code>sharks.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level1">
<h1 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h1>
<p>The time-calibration of molecular phylogenies is essential to many phylogenetic comparative analyses. Time-calibration can be accomplished with e.g. data from fossil specimen that can be assigned to a certain taxonomic group. Specimen ages can be determined by e.g. carbon dating or stratigraphic methods. Node ages are usually assigned using Bayesian or maximum-likelihood methods.</p>
<p>Some of the specimen records at Naturalis hold stratigraphic information. Here we will demonstrate how to extract this data using <code>nbaR</code> and how to create input for the popular tree-calibration function <code>chronos</code> from the phylogenetic analysis package <code>ape</code>.</p>
<div id="the-phylogeny" class="section level2">
<h2 class="hasAnchor">
<a href="#the-phylogeny" class="anchor"></a>The phylogeny</h2>
<p>As input, we will use a species-level molecular shark phylogeny published by <span class="citation">(Vélez-Zuazo and Agnarsson 2011)</span>.</p>
<p>The phylogeny is a majority-rule consensus tree inferred from molecular markers using Bayesian inference and comprises 229 species in all eight orders of the sharks (superorder <em>Selachimorpha</em>):</p>
<p><img src="https://ars.els-cdn.com/content/image/1-s2.0-S1055790310004537-gr3.jpg"></p>
<p>The non-ultrametric tree in the above figure is not time-calibrated, the branch lengths thus represent molecular distances.</p>
</div>
</div>
<div id="getting-chronological-data-with-nbar" class="section level1">
<h1 class="hasAnchor">
<a href="#getting-chronological-data-with-nbar" class="anchor"></a>Getting chronological data with nbaR</h1>
<p>Chronological association is associated with <code>Specimen</code> data, we thus instantiate a <code>SpecimenClient</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(nbaR)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">sc &lt;-<span class="st"> </span>SpecimenClient<span class="op">$</span><span class="kw">new</span>()</a></code></pre></div>
<p>In total, there are <a href="https://en.wikipedia.org/wiki/Shark">eight extant shark orders</a>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">shark_orders &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"Carcharhiniformes"</span>,</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">                  <span class="st">"Heterodontiformes"</span>,</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">                  <span class="st">"Hexanchiformes"</span>,</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">                  <span class="st">"Lamniformes"</span>,</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">                  <span class="st">"Orectolobiformes"</span>,</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">                  <span class="st">"Pristiophoriformes"</span>,</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">                  <span class="st">"Squaliformes"</span>,</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">                  <span class="st">"Squatiniformes"</span>)</a></code></pre></div>
<p>We can then formulate a query condition for specimens that are identified in one of these orders using the operator <code>IN</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">qc &lt;-<span class="st"> </span>QueryCondition<span class="op">$</span><span class="kw">new</span>(<span class="dt">field=</span><span class="st">"identifications.defaultClassification.order"</span>, <span class="dt">operator=</span><span class="st">"IN"</span>, <span class="dt">value=</span>shark_orders)</a></code></pre></div>
<p>For many specimens, chronological information is available in the fields <code>gatheringEvent.chronoStratigraphy.youngChronoName</code> and <code>gatheringEvent.chronoStratigraphy.oldChronoName</code> which represent upper- and lower time bounds, respectively. Below, we will formulate a <code>QueryCondition</code> that requires either one of these fields to be non-empty:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">## formulate query conditions for fields to be non-empty</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">qc2 &lt;-<span class="st"> </span>QueryCondition<span class="op">$</span><span class="kw">new</span>(<span class="dt">field=</span><span class="st">"gatheringEvent.chronoStratigraphy.youngChronoName"</span>, <span class="dt">operator=</span><span class="st">"NOT_EQUALS"</span>, <span class="dt">value=</span><span class="st">""</span>)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">qc3 &lt;-<span class="st"> </span>QueryCondition<span class="op">$</span><span class="kw">new</span>(<span class="dt">field=</span><span class="st">"gatheringEvent.chronoStratigraphy.oldChronoName"</span>, <span class="dt">operator=</span><span class="st">"NOT_EQUALS"</span>, <span class="dt">value=</span><span class="st">""</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5">## join qc2 and qc3 with operator OR</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">qc2<span class="op">$</span>or &lt;-<span class="st"> </span><span class="kw">list</span>(qc3)</a></code></pre></div>
<p>Now we can do the query:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">## instantiate QuerySpec, give size</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">qs &lt;-<span class="st"> </span>QuerySpec<span class="op">$</span><span class="kw">new</span>(<span class="dt">conditions=</span><span class="kw">list</span>(qc, qc3), <span class="dt">size=</span><span class="dv">5000</span>)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">res &lt;-<span class="st"> </span>sc<span class="op">$</span><span class="kw">query</span>(<span class="dt">querySpec =</span> qs)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">## how many hits?</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">res<span class="op">$</span>content<span class="op">$</span>totalSize</a></code></pre></div>
<pre><code>## [1] 4009</code></pre>
<div id="exploring-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#exploring-the-data" class="anchor"></a>Exploring the data</h2>
<p>Now we can explore the data:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">## load all specimens</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">specimens &lt;-<span class="st"> </span><span class="kw">lapply</span>(res<span class="op">$</span>content<span class="op">$</span>resultSet, <span class="cf">function</span>(x)x<span class="op">$</span>item)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">## check the fields youngCronoName and oldChronoName</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="kw">unique</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(specimens, <span class="cf">function</span>(x)x<span class="op">$</span>gatheringEvent<span class="op">$</span>chronoStratigraphy[[<span class="dv">1</span>]]<span class="op">$</span>youngChronoName)))</a></code></pre></div>
<pre><code>##  [1] "Miocene"        "Pliocene"       "Upper Miocene"  "Pleistocene"   
##  [5] "Oligocene"      "Cretaceous"     "Chattian"       "Middle Miocene"
##  [9] "Paleocene"      "Lower Miocene"  "Maastrichtian"  "Pliocene?"</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">unique</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(specimens, <span class="cf">function</span>(x)x<span class="op">$</span>gatheringEvent<span class="op">$</span>chronoStratigraphy[[<span class="dv">1</span>]]<span class="op">$</span>oldChronoName)))</a></code></pre></div>
<pre><code>##  [1] "Neogene"                                          
##  [2] "Middle Miocene"                                   
##  [3] "Middle Eocene"                                    
##  [4] "Mioceen"                                          
##  [5] "Miocene"                                          
##  [6] "Oligocene"                                        
##  [7] "Lower Miocene"                                    
##  [8] "Rupelian"                                         
##  [9] "Unspecified age"                                  
## [10] "Ypresian"                                         
## [11] "Recent"                                           
## [12] "Upper Miocene"                                    
## [13] "Eocene"                                           
## [14] "Pleistocene"                                      
## [15] "Unindentified Age"                                
## [16] "Pliocene"                                         
## [17] "B.Mioceen"                                        
## [18] "Cretaceous"                                       
## [19] "Priabonian"                                       
## [20] "Middle Pliocene"                                  
## [21] "Onderste Rupelien"                                
## [22] "Kwartaire afzetting op zanden van Grimmertingen"  
## [23] "Early Miocene"                                    
## [24] "Upper Eocene"                                     
## [25] "Oligoceen, Rupelien"                              
## [26] "M.mioceen"                                        
## [27] "Paleocene"                                        
## [28] "Tertiair"                                         
## [29] "Onder-Plioceen"                                   
## [30] "Mioceen?"                                         
## [31] "Lower Miocene?"                                   
## [32] "Maastrichtian"                                    
## [33] "Recent?"                                          
## [34] "A. karsteni - Niso sp. Ass. Zone"                 
## [35] "Plio-Pleistocene?"                                
## [36] "Oligoceen"                                        
## [37] "Plio-Pleistoceen"                                 
## [38] "Lower Rupelian"                                   
## [39] "Unindentified A"                                  
## [40] "Unspecified Age"                                  
## [41] "Cenomanian"                                       
## [42] "? Kwartaire afzetting op zanden van Grimmertingen"
## [43] "M.Miocen"                                         
## [44] "Pliocene?"                                        
## [45] "Middle Miocen"</code></pre>
<p><strong>Caution</strong>: As you see above, there can be more than one chronoStratigraphy assigned with a specimen. Check how many we have per specimen:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">unique</span>(<span class="kw">sapply</span>(res<span class="op">$</span>content<span class="op">$</span>resultSet, <span class="cf">function</span>(x)<span class="kw">length</span>(x<span class="op">$</span>item<span class="op">$</span>gatheringEvent<span class="op">$</span>chronoStratigraphy)))</a></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>Each <code>gatheringEvent</code> in each <code>Specimen</code> has only one <code>chronoStratigraphy</code>. We thus do not miss data by taking the first one (<code>chronoStratigraphy[[1]]</code>).</p>
<p>Do we have hits for all orders? Below, we make an overview of the field <code>identifications.defaultClassification.order</code> for all specimen.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">## make table with counts for each order</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">tab &lt;-<span class="st"> </span><span class="kw">table</span>(<span class="kw">unlist</span>(<span class="kw">lapply</span>(specimens, <span class="cf">function</span>(x)x<span class="op">$</span>identifications[[<span class="dv">1</span>]]<span class="op">$</span>defaultClassification<span class="op">$</span>order)))</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="fl">5.1</span>, <span class="dv">8</span>, <span class="fl">4.1</span>, <span class="fl">2.1</span>))</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="kw">barplot</span>(<span class="kw">sort</span>(tab), <span class="dt">horiz=</span>T, <span class="dt">las=</span><span class="dv">2</span>, <span class="dt">xlab=</span><span class="st">"Number of specimens"</span>)</a></code></pre></div>
<p><img src="sharks_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p><strong>Caution</strong>: There can be multiple identifications for one specimen. Some specimens in our data are for instance assigned to different genera. However, the field <code>preferred</code> in an <code>Identification</code> object states if this is the most accurate and recent identification. The preferred identification is usually the first in the list of a specimen’s identifications. It can, however, occur that there are multiple identifications of which none is preferred; it is best to filter them out:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">## get the specimens which have a preferred identification</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">ident &lt;-<span class="st"> </span><span class="kw">sapply</span>(specimens, <span class="cf">function</span>(s)<span class="kw">any</span>(<span class="kw">sapply</span>(s<span class="op">$</span>identifications, <span class="cf">function</span>(i)i<span class="op">$</span>preferred)))</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">## how many do not have a preferred identification?</a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="kw">sum</span>(<span class="op">!</span>ident)</a></code></pre></div>
<pre><code>## [1] 3</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">## filter specimens</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">specimens &lt;-<span class="st"> </span>specimens[ident]</a></code></pre></div>
<p>Let’s further explore the data. To see what part of the animals were preserved, we can look into the field <code>kindOfUnit</code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">table</span>(<span class="kw">sapply</span>(specimens, <span class="st">`</span><span class="dt">[[</span><span class="st">`</span>, <span class="st">"kindOfUnit"</span>))</a></code></pre></div>
<pre><code>## 
## AnimalPart      tooth   vertebra 
##          2       4003          1</code></pre>
<p>Almost all of them are teeth.</p>
</div>
<div id="getting-absolute-ages" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-absolute-ages" class="anchor"></a>Getting absolute ages</h2>
<p>The type of chronostratigraphic data (as shown above) is given in divisions on the geological time scale, e.g. <em>Miocene</em>. These strings can refer to <em>eons</em>, <em>eras</em>, <em>periods</em>, <em>epochs</em> and <em>ages</em>. In order to translate this into absolute ages, we will use the API of the <a href="http://earthlifeconsortium.org/">Earth Life Consortium</a>. This is possible using the <em>convenience function</em> <code>get_age</code>. For example</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">## get the upper chrono name for the first specimen</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">name &lt;-<span class="st"> </span>specimens[[<span class="dv">1</span>]]<span class="op">$</span>gatheringEvent<span class="op">$</span>chronoStratigraphy[[<span class="dv">1</span>]]<span class="op">$</span>oldChronoName</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">name</a></code></pre></div>
<pre><code>## [1] "Neogene"</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">## get the lower and upper bounds for this division</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="kw"><a href="../reference/geo_age.html">geo_age</a></span>(name)</a></code></pre></div>
<pre><code>##           Neogene
## early_age   23.03
## late_age     2.59</code></pre>
<p>We can now make a table with all interesting data, below this is done for the first 50 specimen objects:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">## Get genus, species and chrono information from specimen records</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">data &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">do.call</span>(rbind, <span class="kw">lapply</span>(specimens[<span class="dv">1</span><span class="op">:</span><span class="dv">50</span>], <span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">    genus &lt;-<span class="st"> </span>x<span class="op">$</span>identifications[[<span class="dv">1</span>]]<span class="op">$</span>defaultClassification<span class="op">$</span>genus</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">    <span class="cf">if</span> (<span class="kw">is.null</span>(genus)) genus &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb23-5" data-line-number="5">    specificEpithet &lt;-<span class="st"> </span>x<span class="op">$</span>identifications[[<span class="dv">1</span>]]<span class="op">$</span>defaultClassification<span class="op">$</span>specificEpithet</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">    <span class="cf">if</span> (<span class="kw">is.null</span>(specificEpithet)) specificEpithet &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb23-7" data-line-number="7">    youngChronoName &lt;-<span class="st"> </span>x<span class="op">$</span>gatheringEvent<span class="op">$</span>chronoStratigraphy[[<span class="dv">1</span>]]<span class="op">$</span>youngChronoName</a>
<a class="sourceLine" id="cb23-8" data-line-number="8">    <span class="cf">if</span> (<span class="kw">is.null</span>(youngChronoName)) youngChronoName &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb23-9" data-line-number="9">    oldChronoName &lt;-<span class="st"> </span>x<span class="op">$</span>gatheringEvent<span class="op">$</span>chronoStratigraphy[[<span class="dv">1</span>]]<span class="op">$</span>oldChronoName</a>
<a class="sourceLine" id="cb23-10" data-line-number="10">    <span class="cf">if</span> (<span class="kw">is.null</span>(oldChronoName)) oldChronoName &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb23-11" data-line-number="11">    <span class="kw">c</span>(<span class="dt">genus=</span>genus, <span class="dt">specificEpithet=</span>specificEpithet,</a>
<a class="sourceLine" id="cb23-12" data-line-number="12">      <span class="dt">youngChronoName=</span>youngChronoName, <span class="dt">oldChronoName=</span>oldChronoName)</a>
<a class="sourceLine" id="cb23-13" data-line-number="13">})))</a>
<a class="sourceLine" id="cb23-14" data-line-number="14"></a>
<a class="sourceLine" id="cb23-15" data-line-number="15">## Get absolute ages from earth life consortium</a>
<a class="sourceLine" id="cb23-16" data-line-number="16">times &lt;-<span class="st"> </span><span class="kw"><a href="../reference/geo_age.html">geo_age</a></span>(<span class="kw">unique</span>(<span class="kw">c</span>(<span class="kw">as.character</span>(data<span class="op">$</span>youngChronoName), <span class="kw">as.character</span>(data<span class="op">$</span>oldChronoName))))</a></code></pre></div>
<pre><code>## Warning in FUN(X[[i]], ...): Could not retrieve values for geo unit
## "Mioceen" from earthlifeconsortium.org</code></pre>
<pre><code>## Warning in FUN(X[[i]], ...): Could not retrieve values for geo unit
## "Unspecified age" from earthlifeconsortium.org</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">## add upper and lower bounds to ages</a>
<a class="sourceLine" id="cb26-2" data-line-number="2">data<span class="op">$</span>young_age &lt;-<span class="st"> </span><span class="kw">sapply</span>(data<span class="op">$</span>youngChronoName, <span class="cf">function</span>(x)<span class="kw">ifelse</span>(<span class="kw">is.na</span>(x), <span class="ot">NA</span>, <span class="kw">unlist</span>(times[<span class="st">'late_age'</span>, <span class="kw">as.character</span>(x)])))</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">data<span class="op">$</span>old_age &lt;-<span class="st"> </span><span class="kw">sapply</span>(data<span class="op">$</span>oldChronoName, <span class="cf">function</span>(x)<span class="kw">ifelse</span>(<span class="kw">is.na</span>(x), <span class="ot">NA</span>, <span class="kw">unlist</span>(times[<span class="st">'early_age'</span>, <span class="kw">as.character</span>(x)])))</a>
<a class="sourceLine" id="cb26-4" data-line-number="4"></a>
<a class="sourceLine" id="cb26-5" data-line-number="5">data</a></code></pre></div>
<pre><code>##               genus specificEpithet youngChronoName   oldChronoName
## 1     Ginglymostoma             sp.            &lt;NA&gt;         Neogene
## 2  Megascyliorhinus      sp. indet.            &lt;NA&gt;  Middle Miocene
## 3      Heterodontus            &lt;NA&gt;            &lt;NA&gt;            &lt;NA&gt;
## 4      Heterodontus            &lt;NA&gt;            &lt;NA&gt;            &lt;NA&gt;
## 5      Eostegostoma         angusta            &lt;NA&gt;   Middle Eocene
## 6   Palaeorhincodon           wardi            &lt;NA&gt;   Middle Eocene
## 7   Palaeorhincodon           wardi            &lt;NA&gt;   Middle Eocene
## 8     Pristiophorus             sp.            &lt;NA&gt;         Mioceen
## 9     Pristiophorus      schroederi         Miocene         Miocene
## 10    Pristiophorus     rupeliensis            &lt;NA&gt;       Oligocene
## 11    Pristiophorus     rupeliensis            &lt;NA&gt;       Oligocene
## 12    Chiloscyllium         minutum            &lt;NA&gt;            &lt;NA&gt;
## 13        Hexanchus     primigenius         Miocene         Miocene
## 14        Notidanus     primigenius            &lt;NA&gt;   Lower Miocene
## 15     Notorhynchus     primigenius            &lt;NA&gt;         Mioceen
## 16    Pristiophorus      schroederi        Pliocene         Miocene
## 17     Heterodontus            &lt;NA&gt;            &lt;NA&gt;            &lt;NA&gt;
## 18     Heterodontus        vincenti            &lt;NA&gt;   Middle Eocene
## 19     Heterodontus        vincenti            &lt;NA&gt;   Middle Eocene
## 20     Heterodontus            &lt;NA&gt;            &lt;NA&gt;            &lt;NA&gt;
## 21     Heterodontus            &lt;NA&gt;            &lt;NA&gt;            &lt;NA&gt;
## 22    Pristiophorus      schroederi        Pliocene            &lt;NA&gt;
## 23    Pristiophorus      schroederi        Pliocene         Miocene
## 24    Pristiophorus             sp.            &lt;NA&gt;         Mioceen
## 25    Pristiophorus     rupeliensis            &lt;NA&gt;       Oligocene
## 26   Pristiophorus?      schroederi        Pliocene         Miocene
## 27   Pristiophorus?            &lt;NA&gt;         Miocene         Miocene
## 28    Pristiophorus      schroederi        Pliocene         Miocene
## 29    Pristiophorus      schroederi        Pliocene         Miocene
## 30    Pristiophorus     rupeliensis            &lt;NA&gt;        Rupelian
## 31    Pristiophorus     rupeliensis            &lt;NA&gt;       Oligocene
## 32    Pristiophorus     rupeliensis            &lt;NA&gt;       Oligocene
## 33    Pristiophorus     rupeliensis            &lt;NA&gt;       Oligocene
## 34    Pristiophorus     rupeliensis            &lt;NA&gt;       Oligocene
## 35    Pristiophorus             sp.            &lt;NA&gt;         Mioceen
## 36    Pristiophorus      schroederi        Pliocene         Miocene
## 37    Pristiophorus             sp.            &lt;NA&gt;         Miocene
## 38    Pristiophorus             sp.            &lt;NA&gt;         Mioceen
## 39    Pristiophorus     rupeliensis            &lt;NA&gt;       Oligocene
## 40     Heterodontus            &lt;NA&gt;            &lt;NA&gt;            &lt;NA&gt;
## 41     Heterodontus            &lt;NA&gt;            &lt;NA&gt;            &lt;NA&gt;
## 42     Heterodontus            &lt;NA&gt;            &lt;NA&gt;            &lt;NA&gt;
## 43     Heterodontus            &lt;NA&gt;            &lt;NA&gt;            &lt;NA&gt;
## 44     Heterodontus            &lt;NA&gt;            &lt;NA&gt;            &lt;NA&gt;
## 45     Heterodontus            &lt;NA&gt;            &lt;NA&gt;            &lt;NA&gt;
## 46         Squatina         biforis            &lt;NA&gt;  Middle Miocene
## 47         Squatina         biforis            &lt;NA&gt;  Middle Miocene
## 48         Squatina           prima            &lt;NA&gt; Unspecified age
## 49         Squatina      sp. indet.            &lt;NA&gt;  Middle Miocene
## 50         Squatina         biforis            &lt;NA&gt;  Middle Miocene
##    young_age old_age
## 1         NA   23.03
## 2         NA   15.97
## 3         NA      NA
## 4         NA      NA
## 5         NA   48.60
## 6         NA   48.60
## 7         NA   48.60
## 8         NA      NA
## 9       5.33   23.03
## 10        NA   33.90
## 11        NA   33.90
## 12        NA      NA
## 13      5.33   23.03
## 14        NA   23.03
## 15        NA      NA
## 16      2.59   23.03
## 17        NA      NA
## 18        NA   48.60
## 19        NA   48.60
## 20        NA      NA
## 21        NA      NA
## 22      2.59      NA
## 23      2.59   23.03
## 24        NA      NA
## 25        NA   33.90
## 26      2.59   23.03
## 27      5.33   23.03
## 28      2.59   23.03
## 29      2.59   23.03
## 30        NA   33.90
## 31        NA   33.90
## 32        NA   33.90
## 33        NA   33.90
## 34        NA   33.90
## 35        NA      NA
## 36      2.59   23.03
## 37        NA   23.03
## 38        NA      NA
## 39        NA   33.90
## 40        NA      NA
## 41        NA      NA
## 42        NA      NA
## 43        NA      NA
## 44        NA      NA
## 45        NA      NA
## 46        NA   15.97
## 47        NA   15.97
## 48        NA      NA
## 49        NA   15.97
## 50        NA   15.97</code></pre>
</div>
</div>
<div id="calibrating-the-phylogeny" class="section level1">
<h1 class="hasAnchor">
<a href="#calibrating-the-phylogeny" class="anchor"></a>Calibrating the phylogeny</h1>
<p>Depending on the data, calibration points could be chosen on different taxonomic levels. If there are sufficient specimens determined at species level, one could use the upper- and lower bounds above. It is also possible to average upper- and lower values for a higher taxonomic group, such as genus or family. Since this requires some data cleaning, such as dealing with duplicates, missing data, etc, <code>nbaR</code> offers the function <code>chronos_calib</code> which takes a set of specimen object, and a tree and averages the data for a user-defined taxonomic group and returns a calibration table that can be directly used as input for the function <code>chronos</code> from the package <code>ape</code>. The function also determines the node which will be calibrated in the phylogenetic tree.</p>
<p>The shark phylogeny comes with the package and can be parsed using the package <code>ape</code>:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw">library</span>(ape)</a>
<a class="sourceLine" id="cb28-2" data-line-number="2"></a>
<a class="sourceLine" id="cb28-3" data-line-number="3">## read data</a>
<a class="sourceLine" id="cb28-4" data-line-number="4">path &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">'extdata'</span>, <span class="st">'shark_tree.nex'</span>, <span class="dt">package=</span><span class="st">'nbaR'</span>)</a>
<a class="sourceLine" id="cb28-5" data-line-number="5">tree &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ape/topics/read.nexus">read.nexus</a></span>(path)</a>
<a class="sourceLine" id="cb28-6" data-line-number="6"></a>
<a class="sourceLine" id="cb28-7" data-line-number="7">## plot the tree</a>
<a class="sourceLine" id="cb28-8" data-line-number="8"><span class="kw">plot</span>(tree, <span class="dt">cex=</span><span class="fl">0.3</span>)</a></code></pre></div>
<p><img src="sharks_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<div id="genus-level" class="section level2">
<h2 class="hasAnchor">
<a href="#genus-level" class="anchor"></a>Genus level</h2>
<p>Now we use <code>chronos_calib</code> to get the table at the genus level. <code>chronos_calib</code> also selects the nodes in the tree that will be calibrated. This is done by selecting the most recent common ancestor (mrca) of the species for which the data are averaged.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">## make calibration table on genus level</a>
<a class="sourceLine" id="cb29-2" data-line-number="2">calibration_table &lt;-<span class="st"> </span><span class="kw"><a href="../reference/chronos_calib.html">chronos_calib</a></span>(specimens, tree, <span class="st">"genus"</span>)</a></code></pre></div>
<p><strong>Note</strong>: This function can produce many warnings, a warning is emitted whenever, for some geological division, no data can be obtained from the earth life consortium. This can be due to misspellings or words in foreign languages.</p>
<p>The calibration table looks as follows:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1">calibration_table</a></code></pre></div>
<pre><code>##    node   age.min  age.max soft.bounds         taxon
## 1   432  2.635714 21.35846       FALSE  Carcharhinus
## 2   364  0.870000 25.12714       FALSE        Galeus
## 3   311 66.000000 83.20000       FALSE  Heterodontus
## 4   243  5.444545 21.84214       FALSE     Hexanchus
## 5   320  4.745833 16.46489       FALSE        Isurus
## 6   318 28.984615 49.32840       FALSE         Lamna
## 7   245  3.503333 26.13571       FALSE Pristiophorus
## 8   346  3.960000 30.67263       FALSE  Scyliorhinus
## 9   428  0.010000 20.20600       FALSE       Sphyrna
## 10  297  5.708182 30.13364       FALSE       Squalus
## 11  237 16.384000 30.11038       FALSE      Squatina</code></pre>
<p><strong>Note</strong>: It is essential to thoroughly evaluate the calibration table! In this example, for example, the genus <em>Squatina</em> is non-monophyletic and one species is placed somewhere else in the tree. Calibrating the most recent common ancestor node for this genus can therefore result in errors using the calibration routine. We will therefore remove the calibration points for genus <em>Squatina</em> before calibration:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">## clean up: one rogue taxon in genus "Squatina"! Skip this genus</a>
<a class="sourceLine" id="cb32-2" data-line-number="2">calibration_table &lt;-<span class="st"> </span>calibration_table[calibration_table<span class="op">$</span>taxon <span class="op">!=</span><span class="st"> "Squatina"</span>,]</a>
<a class="sourceLine" id="cb32-3" data-line-number="3"></a>
<a class="sourceLine" id="cb32-4" data-line-number="4">## run ape's chronos</a>
<a class="sourceLine" id="cb32-5" data-line-number="5">chronogram &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ape/topics/chronos">chronos</a></span>(tree, <span class="dt">calibration=</span>calibration_table)</a>
<a class="sourceLine" id="cb32-6" data-line-number="6"></a>
<a class="sourceLine" id="cb32-7" data-line-number="7">## plot tree with time axis</a>
<a class="sourceLine" id="cb32-8" data-line-number="8"><span class="kw">plot</span>(chronogram, <span class="dt">cex=</span><span class="fl">0.3</span>)</a>
<a class="sourceLine" id="cb32-9" data-line-number="9"><span class="kw"><a href="http://www.rdocumentation.org/packages/ape/topics/axisPhylo">axisPhylo</a></span>()</a>
<a class="sourceLine" id="cb32-10" data-line-number="10"></a>
<a class="sourceLine" id="cb32-11" data-line-number="11">## plot calibrated genera</a>
<a class="sourceLine" id="cb32-12" data-line-number="12"><span class="kw"><a href="http://www.rdocumentation.org/packages/ape/topics/nodelabels">nodelabels</a></span>(calibration_table<span class="op">$</span>taxon, calibration_table<span class="op">$</span>node)</a></code></pre></div>
</div>
<div id="family-level" class="section level2">
<h2 class="hasAnchor">
<a href="#family-level" class="anchor"></a>Family level</h2>
<p>We can also calibrate the tree on the family level:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">## make calibration table on family level</a>
<a class="sourceLine" id="cb33-2" data-line-number="2">calibration_table &lt;-<span class="st"> </span><span class="kw"><a href="../reference/chronos_calib.html">chronos_calib</a></span>(specimens, tree, <span class="st">"family"</span>)</a>
<a class="sourceLine" id="cb33-3" data-line-number="3"></a>
<a class="sourceLine" id="cb33-4" data-line-number="4">## run ape's chronos</a>
<a class="sourceLine" id="cb33-5" data-line-number="5">chronogram &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ape/topics/chronos">chronos</a></span>(tree, <span class="dt">calibration=</span>calibration_table)</a>
<a class="sourceLine" id="cb33-6" data-line-number="6"></a>
<a class="sourceLine" id="cb33-7" data-line-number="7">## plot tree with time axis</a>
<a class="sourceLine" id="cb33-8" data-line-number="8"><span class="kw">plot</span>(chronogram, <span class="dt">cex=</span><span class="fl">0.3</span>)</a>
<a class="sourceLine" id="cb33-9" data-line-number="9"><span class="kw"><a href="http://www.rdocumentation.org/packages/ape/topics/axisPhylo">axisPhylo</a></span>()</a>
<a class="sourceLine" id="cb33-10" data-line-number="10"></a>
<a class="sourceLine" id="cb33-11" data-line-number="11">## plot calibrated families</a>
<a class="sourceLine" id="cb33-12" data-line-number="12"><span class="kw"><a href="http://www.rdocumentation.org/packages/ape/topics/nodelabels">nodelabels</a></span>(calibration_table<span class="op">$</span>taxon, calibration_table<span class="op">$</span>node)</a></code></pre></div>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-VELEZZUAZO2011207">
<p>Vélez-Zuazo, Ximena, and Ingi Agnarsson. 2011. “Shark Tales: A Molecular Species-Level Phylogeny of Sharks (Selachimorpha, Chondrichthyes).” <em>Molecular Phylogenetics and Evolution</em> 58 (2): 207–17. <a href="https://doi.org/https://doi.org/10.1016/j.ympev.2010.11.018" class="uri">https://doi.org/https://doi.org/10.1016/j.ympev.2010.11.018</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#background">Background</a><ul class="nav nav-pills nav-stacked">
<li><a href="#the-phylogeny">The phylogeny</a></li>
      </ul>
</li>
      <li>
<a href="#getting-chronological-data-with-nbar">Getting chronological data with nbaR</a><ul class="nav nav-pills nav-stacked">
<li><a href="#exploring-the-data">Exploring the data</a></li>
      <li><a href="#getting-absolute-ages">Getting absolute ages</a></li>
      </ul>
</li>
      <li>
<a href="#calibrating-the-phylogeny">Calibrating the phylogeny</a><ul class="nav nav-pills nav-stacked">
<li><a href="#genus-level">Genus level</a></li>
      <li><a href="#family-level">Family level</a></li>
      </ul>
</li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Hannes Hettling, Rutger Vos.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
