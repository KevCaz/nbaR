---
title: "nbaR: R access to the Netherlands Biodiversity API"
author: "Hannes Hettling"
date: "`r format(Sys.time(), '%b %d, %Y')`"
output: 
  html_document:
    highlight: tango
    code_folding: show
    theme: sandstone
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      
vignette: >
  %\VignetteIndexEntry{nbaR: R access to the Netherlands Biodiversity API}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Background

## The Netherlands Biodiversity API
The Netherlands Biodiversity API
(NBA) facilitates access to the Natural History Collection at 
Naturalis Biodiversity Center. Next to museum specimen records
and metadata, access to taxonomic classification and nomenclature,
to geographical information, and to multimedia files is provided. By
using the powerful Elasticsearch engine, the NBA facilitates searching
for collection- and biodiversity data in near real-time. Furthermore,
by incorporating information from taxonomic databases, taxonomic name
resolution can be accomplished with the NBA. Persistent Uniform
Resource Identifiers (PURLs) ensure that each specimen accessible via
the NBA is represented by a citable unambiguous web reference. Access
to our data is provided via a RESTful interface and several clients such
as the [BioPortal](http://bioportal.naturalis.nl/), a web application
for browsing biodiversity data that is served by the NBA.  For more
information about the NBA, please see our
[detailed documentation](http://docs.biodiversitydata.nl/).

## R access
The R programming language is established as a common tool in scientific 
resarch, with growing adoption by researchers in biodiversity research.
Hence, to ease the access to the NBA for researchers, we developed this R 
client.

# Getting started

## Main data types and classes
The data served by the NBA consists of four main data types:

* Specimen
* Taxon
* Multimedia
* Geo

Additionally, the data type *Metadata* stores miscellaneous
information about NBA settings. Each of the data types is modelled
as an `R6` class and therefore has its own members such as fields
and methods. Documentation about a specific class can be retrieved
in the standard manner, e.g. `?Specimen`
Each class of the data model can be instanciated and has a `toJSONString` and `toList` method returning
the object's JSON representation and the object's data as a list datatype, respectively.

```{r}
# load nbaR
library('nbaR')                                        

# instanciate specimen object
spec <- Specimen$new()
```
```r
# represent data as JSON or list
spec$toJSONString()
spec$toList()
```

## API Client classes
The interaction with the API is accomplished by the API client classes:

* SpecimenClient
* TaxonClient
* MultimediaClient
* GeoClient
* MetadataClient


```{r}

# initialize client
client <- SpecimenClient$new()
```

The client class is by default initialized to connect to the base URL http://api.biodiversitydata.nl/v2.
For testing purposes, this can be set to a different URL, see `?SpecimenClient` for details.

## Queries

### Concept

With the SpecimentClient created above, the `query` endpoint for specimens can now be reached via the `query` function.

```{r}
# retrieve results of empty query.
res <- client$query()
```

The `query` function then returns an object of class `Response`, which, in turn, has a field `content`
of class `QueryResult`. From the `QueryResult`, the single result items can be accessed as follows:

```{r}
# get first element of results
spec <- res$content$resultSet[[1]]$item

# object should be of type Specimen
class(spec)

```

### Passing query parameters as list
Query parameters can be specified as a list with named parameters.
To query for instance for specimen records that have the type status holotype and a female sex,
one can pass a named list as the `queryParams` parameter to the `query` function:

```{r}
# specify two query conditions
l <- list(identifications.typeStatus="holotype", sex="female")

# run query
res <- client$query(queryParams=l)
```

Note that by default, both conditions are connected by a logical `AND`. 
The `queryParams` passed as a list thus correspond to 
basic [*human readable* queries](http://docs.biodiversitydata.nl/en/latest/quickstart/#human-readable).
For more advanced queries, containing different logical operators or nested subqueries, 
the user can specify tha query in a `QuerySpec` object.

# Advanced queries

## Using the QuerySpec object
Advanced queries with different operators than `AND` or nested query conditions 
can not be accomplished by simply passing the query parameters as a list. 
Instead, a query is modeled as a `QuerySpec` obejct which
captures the relationships between multiple query terms. Please also refer to the 
[NBA QuerySpec documentation](http://docs.biodiversitydata.nl/en/latest/advanced-queries/#queryspec) for more information.

A `QuerySpec` object usually consists of one or more `QueryCondition` objects, specifying 
query terms. A `QueryCondition` object usually contains the fields `field`, `operator`, and `value `(see also `?QueryCondition`).
These fields can be specified in the constructor. If, for example, we want to query for records with a unitID equal to
*L.4304195*, a `QueryCondition` would look as follows:

```{r}
# specify search in QueryCondition object
qc <- QueryCondition$new(field="unitID", operator="EQUALS", value="L.4304195")
```

Note: The function `getFieldInfo` on a certain field lists which operators 
are allowed for that field (e.g. ```sc$get_field_info()$content$unitID$allowedOperators```).

Now, a `QuerySpec` object can be assembled with the `QueryCondition`(s) passed as a list:

```{r}
# build QuerySpec using above conditions
qs <- QuerySpec$new(conditions=list(qc))

# do the query
res <- client$query(querySpec=qs)
```

Below, we show an example of how to nest multiple query conditions. The query conditions below define to query for 
specimens of sex ** female* and family *Equidae* and of rank *Species*. 

```{r}
# specify multiple conditions
q1 <- QueryCondition$new(field = "sex", operator="EQUALS",
                         value="female")
q2 <- QueryCondition$new(field="identifications.defaultClassification.family",
                         operator="EQUALS",
                         value="Equidae")
q3 <- QueryCondition$new(field="identifications.taxonRank",
                         operator="EQUALS", value="species")
```

Extending the constraint to also inclu specimens of rank *Subspecies*,  
we can combine the latter condition with an additional one using the method `or`:
 
```{r}
# logical conjunction using 'or' method
q3$or<- list(QueryCondition$new(field = "identifications.taxonRank",
                                operator="EQUALS",
                                value="subspecies"))

# build QuerySpec from QueryConditions
qs <-QuerySpec$new(conditions=list(q1, q2, q3))

# call API
res <-client$query(querySpec=qs)
```


```{r}
# get 1000 specimen items from plant order 'Gentianales'
qc <- QueryCondition$new(field = "identifications.defaultClassification.order",
                         operator="EQUALS",
                         value="Gentianales")
qs <- QuerySpec$new(conditions=list(qc), size=1000)
res <- client$query(querySpec=qs)

# extract orders from first identification of each specimen
families <- unlist(sapply(res$content$resultSet,
                          function(x)x$item$identifications[[1]]$defaultClassification$family))
# plot frequencies
barplot(table(families), horiz=T,
        col=rainbow(length(unique(families))),
        las=2, xlab="frequency", cex.names=0.5)
```

# Datatype specific services

## Specimen occurrence services {.tabset}
Specimen records constitute the core of
data served by the NBA. Museum specimens can represent a whole variety
of different objects such as plants, animals or single parts thereof,
DNA samples, fossils, rocks or meteorites. For detailed information of the
data model, please refer to the [official documentation in the NBA](http://docs.biodiversitydata.nl/en/latest/doc-spec-services/specimen/).

All specimen occurrence services are accessible using the methods within the `SpecimenClient` class. 
For a list of available endpoints, please refer to the class documentation (`?Specimen`). Below, 
we will give details about all services, grouped by category.

### Query services
#### query
Querying for specimens is accomplished with the `query` method in the class `SpecimenClient`. For simple queries, 
query parameters of type `list` can be passed via the parameter `queryParams`, for example we 
can query specimens of the Family *Ebenaceae* that were collected in Europe:

```{r}
# instantiate specimen client
sc <- SpecimenClient$new()

# specify query params in named list
qp <- list(identifications.defaultClassification.family="Ebenaceae", gatheringEvent.continent="Europe")

# query
res <- sc$query(queryParams=qp)
```

If we now want to know all the countries that the specimens were collected in, we can access the `Specimen` objects in ```res$content$resultSet```
as follows:

```{r}
sapply(res$content$resultSet, function(x)x$item$gatheringEvent$country)
```

Note that passing query parameters as a named list only allows forl limited queries; the locical conjunction between 
parameters is for example always `AND`. More complex queries can be accomplished using the `QuerySpec` object.

### Data access services
Several access methods offer the convenient retrieval of specimens matching a certain 
identifier or being part of a certain collection. Currently implemented data access services for Specimen records are:

#### exists 
Check if a record exists, based on its *unitID*:

```{r}
# use SpecimenClient instantiated above
res <- sc$exists('ZMA.INS.1255440')                                        

# content is boolean
res$content
```

#### find 
Return a single specimen given its identifier (Note: the identifier of a specimen is different 
from the unitID, see also [here](http://docs.biodiversitydata.nl/en/latest/doc-spec-services/specimen/#specids)):

```{r}
id <- "RMNH.MAM.17209.B@CRS"
res <- sc$find(id)

# content is single specimen object
res$content
```

#### find_by_ids
Same as `find`, but takes multiple IDs:

```{r}
ids <- "RMNH.INS.657083@CRS,L.1589244@BRAHMS"
res <- sc$find_by_ids(ids)
```

#### find_by_unit_id
Find a specimen by its `unitID`:
```{r}
unitID <- "RMNH.MAM.1513"
res <- sc$find_by_unit_id(unitID)
```

#### Aggregation services
Aggregation services summarize available data according to different criteria. 

#### get_distinct_values
This method takes a specific field as an argument and returns all possible values and the frequency for that 
field in thy data. Below we get all possible values for the country in which a specimen was collected. 
**Note**: By default, `get_distinct_values` lists only the first 10 hits.
This number can be increased with e.g. setting the `size` parameter in a `QuerySpec` object passed to the method:

```r
sc$get_distinct_values("gatheringEvent.country", QuerySpec$new(size=10000))
```


#### Specimen metadata services

#### Download services





## Taxonomic data services
aa
## Geographic data services
aa
## Multimedia services
aa
