---
title: "nbaR: R access to the Netherlands Biodiversity API"
author: "Hannes Hettling"
date: "`r Sys.Date()`"
output: 
  html_document:
    highlight: zenburn
    code_folding: show
    theme: sandstone
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
      
vignette: >
  %\VignetteIndexEntry{nbaR: R access to the Netherlands Biodiversity API}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Background

## The Netherlands Biodiversity API
The Netherlands Biodiversity API
(NBA) facilitates access to the Natural History Collection at the
Naturalis Biodiversity Center. Next to than museum specimen records
and metadata, access to taxonomic classification and nomenclature,
geographical information, and to multimedia files is provided. By
using the powerful Elasticsearch engine, the NBA facilitates searching
for collection- and biodiversity data in near real-time. Furthermore,
by incorporating information from taxonomic databases, taxonomic name
resolution can be accomplished with the NBA. Persistent Uniform
Resource Identifiers (PURLs) ensure that each species accessible via
the NBA is represented by a citable unambiguous web reference. Access
to our data is provided via a REST interface and several clients such
as the [BioPortal](http://bioportal.naturalis.nl/), a web application
for browsing biodiversity data that is served by the NBA.  For more
information about the NBA, please see our
[detailed documentation](http://docs.biodiversitydata.nl/).

## R access
The R programming language is established as a common tool in scientific resarch.
To ease the access to the NBA for researchers, we developed this R client.

# Getting started

## Main data types and classes
The data served by the NBA consists of four main data types:

* Specimen
* Taxon
* Multimedia
* Geo

Additionally, the data type *Metadata* stores miscellaneous
information about NBA settings. Each of the data types is modelled
as an `R6` class and therefore has its own members such as fields
and methods. Documentation about a specific class can be retrieved
in the standard manner, e.g. `?Specimen`
Each class of the data model can be instanciated and has a `toJSONString` and `toList` method returning
the object's JSON representation and the object's data as a list datatype, respectively.

```{r}
# load nbaR
library('nbaR')                                        

# instanciate specimen object
spec <- Specimen$new()

# represent data as JSON or list
spec$toJSONString()
spec$toList()
```

## API Client classes
The interaction with the API is accomplished by the API client classes:

* SpecimenClient
* TaxonClient
* MultimediaClient
* GeoClient
* MetadataClient


```{r}

# initialize client
client <- SpecimenClient$new()
```

The client class is by default initialized to connect to the base URL http://api.biodiversitydata.nl/v2.
For testing purposes, this can be set to a different URL, see `?SpecimenClient` for details.

## Queries

### Concept

With the SpecimentClient created above, the `query` endpoint for specimens can now be reached via the `query` function.

```{r}
# retrieve results of empty query.
res <- client$query()
```

The `query` function then returns an object of class `Response`, which, in turn, has a field `content`
of class `QueryResult`. From the `QueryResult`, the single result items can be accessed as follows:

```{r}
# get first element of results
spec <- res$content$resultSet[[1]]$item

# object should be of type Specimen
class(spec)

```

### Passing query parameters as list
Query parameters can be specified as a list with named parameters.
To query for instance for specimen records that have the type status holotype and a female sex,
one can pass a named list as the `queryParams` parameter to the `query` function:

```{r}
# specify two query conditions
l <- list(identifications.typeStatus="holotype", sex="female")

# run query
res <- client$query(queryParams=l)
```

Note that by default, both conditions are connected by a logical `AND`. 
The `queryParams` passed as a list thus correspond to 
basic [*human readable* queries](http://docs.biodiversitydata.nl/en/latest/quickstart/#human-readable).
For more advanced queries, containing different logical operators or nested subqueries, 
the user can specify tha query in a `QuerySpec` object.

# Advanced queries

## Using the QuerySpec object
```{r}
# specify search in QueryCondition object
qc <- QueryCondition$new(field="unitID", operator="EQUALS", value="L.4304195")

# build QuerySpec using above conditions
qs <- QuerySpec$new(conditions=list(qc))

# do the query
res <- client$query(querySpec=qs)
```


```{r}
# specify multiple conditions
q1 <- QueryCondition$new(field = "sex", operator="EQUALS",
                         value="female")
q2 <- QueryCondition$new(field="identifications.defaultClassification.family",
                         operator="EQUALS",
                         value="Equidae")
q3 <- QueryCondition$new(field="identifications.taxonRank",
                         operator="EQUALS", value="species")

# logical conjunction using 'or' method
q3$or<- list(QueryCondition$new(field = "identifications.taxonRank",
                                operator="EQUALS",
                                value="subspecies"))

# build QuerySpec from QueryConditions
qs <-QuerySpec$new(conditions=list(q1, q2, q3))

# call API
res <-client$query(querySpec=qs)
```


```{r}
# get 1000 specimen items from plant order 'Gentianales'
qc <- QueryCondition$new(field = "identifications.defaultClassification.order",
                         operator="EQUALS",
                         value="Gentianales")
qs <- QuerySpec$new(conditions=list(qc), size=1000)
res <- client$query(querySpec=qs)

# extract orders from first identification of each specimen
families <- unlist(sapply(res$content$resultSet,
                          function(x)x$item$identifications[[1]]$defaultClassification$family))
# plot frequencies
barplot(table(families), horiz=T,
        col=rainbow(length(unique(families))),
        las=2, xlab="frequency", cex.names=0.5)
```

# Datatype specific services {.tabset}

## Specimen occurrence services {.tabset}
Specimen records constitute the core of
data served by the NBA. Museum specimens can represent a whole variety
of different objects such as plants, animals or single parts thereof,
DNA samples, fossils, rocks or meteorites. For detailed information of the
data model, please refer to the [official documentation in the NBA](http://docs.biodiversitydata.nl/en/latest/doc-spec-services/specimen/).

All specimen occurrence services are accessible using the methods within the `SpecimenClient` class. 
For a list of available endpoints, please refer to the class documentation (`?Specimen`). Below, 
we will give details about all services, grouped by category.

### Query services



### Data access services

### Specimen metadata services

### Download services





## Taxonomic data services
aa
## Geographic data services
aa
## Multimedia services
aa
